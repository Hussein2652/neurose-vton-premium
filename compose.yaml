services:
  api:
    image: neurose-vton-premium:dev
    build:
      context: .
      dockerfile: Dockerfile
    pull_policy: never
    ports:
      - "8000:8000"
    gpus: all
    environment:
      NEUROSE_DEFAULT_SEED: "${NEUROSE_DEFAULT_SEED:-12345}"
      NEUROSE_STRICT_DETERMINISM: "${NEUROSE_STRICT_DETERMINISM:-1}"
      NEUROSE_LOG_LEVEL: "${NEUROSE_LOG_LEVEL:-INFO}"
      NEUROSE_MODEL_INSIGHTFACE: "${NEUROSE_MODEL_INSIGHTFACE}"
      NEUROSE_MODEL_OPENPOSE: "${NEUROSE_MODEL_OPENPOSE}"
      NEUROSE_MODEL_SCHP: "${NEUROSE_MODEL_SCHP}"
      NEUROSE_MODEL_DEPTH: "${NEUROSE_MODEL_DEPTH}"
      NEUROSE_MODEL_SMPLX: "${NEUROSE_MODEL_SMPLX}"
      NEUROSE_MODEL_RELIGHT_SH: "${NEUROSE_MODEL_RELIGHT_SH}"
      NEUROSE_SKIP_ZOEDEPTH: "${NEUROSE_SKIP_ZOEDEPTH:-0}"
      NEUROSE_ZOEDEPTH_REPO: "${NEUROSE_ZOEDEPTH_REPO}"
      NEUROSE_SCHP_INLINE: "${NEUROSE_SCHP_INLINE:-1}"
      NEUROSE_SCHP_FP16: "${NEUROSE_SCHP_FP16:-1}"
      NEUROSE_SCHP_STRICT: "${NEUROSE_SCHP_STRICT:-1}"
      # CUDA / Torch cache env
      TORCH_CUDA_ARCH_LIST: "${TORCH_CUDA_ARCH_LIST:-8.6}"
      TORCH_HOME: "${TORCH_HOME:-/app/runtime_cache/torch}"
      HF_HOME: "${HF_HOME:-/app/runtime_cache/hf}"
      CUBLAS_WORKSPACE_CONFIG: "${CUBLAS_WORKSPACE_CONFIG:-:4096:8}"
      CUDA_HOME: "${CUDA_HOME:-/usr/local/cuda}"
      PYTHONWARNINGS: "${PYTHONWARNINGS}"
      XDG_CONFIG_HOME: "/app/runtime_cache/.config"
      XDG_CACHE_HOME: "/app/runtime_cache/.cache"
    volumes:
      - ./storage:/app/storage:ro
      - ./manual_downloads:/app/manual_downloads:ro
      - ./third_party:/app/third_party:ro
      - ./outputs:/app/outputs
      - ./runtime_cache:/app/runtime_cache
      - ./neurose_vton:/app/neurose_vton
      - ./scripts:/app/scripts
    develop:
      watch:
        - action: sync
          path: ./neurose_vton
          target: /app/neurose_vton
          ignore:
            - "**/__pycache__/**"
            - "**/*.pyc"
        - action: sync
          path: ./scripts
          target: /app/scripts
        - action: rebuild
          path: ./requirements.lock
        - action: rebuild
          path: ./Dockerfile
