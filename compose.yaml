services:
  api:
    image: neurose-vton-premium:dev
    build:
      context: .
      dockerfile: Dockerfile
    pull_policy: never
    ports:
      - "8000:8000"
    gpus: all
    environment:
      NEUROSE_DEFAULT_SEED: "${NEUROSE_DEFAULT_SEED:-12345}"
      NEUROSE_STRICT_DETERMINISM: "${NEUROSE_STRICT_DETERMINISM:-1}"
      NEUROSE_LOG_LEVEL: "${NEUROSE_LOG_LEVEL:-INFO}"
      NEUROSE_MODEL_INSIGHTFACE: "/app/runtime_cache/Person Analysis Models/insightface/antelopev2"
      NEUROSE_MODEL_OPENPOSE: "/app/runtime_cache/Person Analysis Models/yolo_pose/yolov8x-pose.pt"
      NEUROSE_MODEL_SCHP: "/app/runtime_cache/Person Analysis Models"
      NEUROSE_MODEL_DEPTH: "/app/runtime_cache/Person Analysis Models/zoedepth/ZoeD_M12_NK.pt"
      NEUROSE_MODEL_SMPLX: "/app/runtime_cache/Person Analysis Models/smplx"
      NEUROSE_SKIP_ZOEDEPTH: "${NEUROSE_SKIP_ZOEDEPTH:-0}"
      NEUROSE_ZOEDEPTH_REPO: "/app/runtime_cache/Person Analysis Models/zoedepth_repo/ZoeDepth-main"
      NEUROSE_SCHP_INLINE: "${NEUROSE_SCHP_INLINE:-1}"
      NEUROSE_SCHP_FP16: "${NEUROSE_SCHP_FP16:-1}"
      NEUROSE_SCHP_STRICT: "${NEUROSE_SCHP_STRICT:-1}"
      TORCH_CUDA_ARCH_LIST: "${TORCH_CUDA_ARCH_LIST:-8.6}"
    volumes:
      - ./storage:/app/storage:ro
      - ./manual_downloads:/app/manual_downloads:ro
      - ./third_party:/app/third_party:ro
      - ./outputs:/app/outputs
      - ./runtime_cache:/app/runtime_cache
      - ./neurose_vton:/app/neurose_vton
      - ./scripts:/app/scripts
    develop:
      watch:
        - action: sync
          path: ./neurose_vton
          target: /app/neurose_vton
          ignore:
            - "**/__pycache__/**"
            - "**/*.pyc"
        - action: sync
          path: ./scripts
          target: /app/scripts
        - action: rebuild
          path: ./requirements.lock
        - action: rebuild
          path: ./Dockerfile
